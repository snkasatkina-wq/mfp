<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ú–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      min-height: 100vh;
    }
    
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tab {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-text-color, #000000);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .tab-active {
      background: var(--tg-theme-button-color, #2a9df4);
      color: var(--tg-theme-button-text-color, #ffffff);
    }

    h1 {
      font-size: 24px;
      margin: 0 0 8px 0;
      font-weight: 600;
    }
    
    .greeting {
      font-size: 16px;
      color: var(--tg-theme-hint-color, #999999);
      margin-bottom: 16px;
    }
    
    .image-container {
      text-align: center;
      margin: 20px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .image-container img {
      max-width: 200px;
      width: 100%;
      height: auto;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: block;
    }
    
    .generate-btn {
      margin-top: 0;
      padding: 10px 20px;
      font-size: 14px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-text-color, #000000);
      width: auto;
      display: inline-block;
    }
    
    .expenses-section {
      margin-top: 24px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .expense {
      padding: 12px;
      border-radius: 12px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      margin-bottom: 8px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .expense-left {
      flex: 1;
    }
    
    .expense-amount {
      font-size: 18px;
      font-weight: 600;
      color: var(--tg-theme-button-color, #2a9df4);
      margin-bottom: 4px;
    }
    
    .expense-category {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #999999);
      margin-bottom: 4px;
    }
    
    .expense-description {
      font-size: 14px;
      color: var(--tg-theme-text-color, #000000);
    }
    
    .expense-date {
      font-size: 11px;
      color: var(--tg-theme-hint-color, #999999);
      white-space: nowrap;
      margin-left: 12px;
    }
    
    #empty {
      text-align: center;
      padding: 40px 20px;
      font-size: 14px;
      color: var(--tg-theme-hint-color, #999999);
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--tg-theme-hint-color, #999999);
    }
    
    button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      background: var(--tg-theme-button-color, #2a9df4);
      color: var(--tg-theme-button-text-color, #ffffff);
      cursor: pointer;
      width: 100%;
      font-weight: 500;
    }
    
    button:active {
      opacity: 0.8;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .input-section {
      margin: 20px 0;
    }
    
    .input-container {
      display: flex;
      gap: 12px;
      align-items: stretch;
      width: 100%;
    }
    
    #universal-input {
      flex: 1;
      min-width: 0;
      padding: 12px;
      font-size: 14px;
      border-radius: 12px;
      border: 1px solid var(--tg-theme-hint-color, #cccccc);
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      font-family: inherit;
    }
    
    #universal-input:focus {
      outline: none;
      border-color: var(--tg-theme-button-color, #2a9df4);
    }
    
    .send-btn {
      padding: 0;
      width: 44px;
      height: 44px;
      min-width: 44px;
      max-width: 44px;
      font-size: 20px;
      border-radius: 12px;
      border: none;
      background: var(--tg-theme-button-color, #2a9df4);
      color: var(--tg-theme-button-text-color, #ffffff);
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .send-btn:active {
      opacity: 0.8;
    }
    
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .input-hint {
      margin-top: 8px;
      font-size: 12px;
      color: var(--tg-theme-hint-color, #999999);
      text-align: center;
      min-height: 16px;
    }

    .categories-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .category-chip {
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-text-color, #000000);
      font-size: 13px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      width: auto;
      margin-top: 0;
    }

    .category-chip-active {
      background: var(--tg-theme-button-color, #2a9df4);
      color: var(--tg-theme-button-text-color, #ffffff);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üí∞ –ú–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã</h1>
    <div class="greeting" id="greeting">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <div class="tabs">
    <button id="tab-expenses" class="tab tab-active">–†–∞—Å—Ö–æ–¥—ã</button>
    <button id="tab-categories" class="tab">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
  </div>

  <div class="image-container">
    <img id="user-image" src="/static/piggy.png" alt="–ö–æ–ø–∏–ª–∫–∞" />
    <button id="generate-image-btn" class="generate-btn">üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
    <button id="manage-categories-btn" class="generate-btn">‚ûï –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
    <button id="upload-receipt-btn" class="generate-btn">üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫</button>
    <input
      id="upload-receipt-input"
      type="file"
      accept="image/*"
      style="display:none"
    />
  </div>

  <div class="input-section">
    <div class="input-container">
      <input 
        type="text" 
        id="universal-input" 
        placeholder="–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–µ–π—Å—Ç–≤–∏—è –≤—ã—à–µ..." 
        maxlength="200"
        disabled
      />
      <button id="send-btn" class="send-btn" disabled title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚úì</button>
    </div>
    <div id="input-hint" class="input-hint"></div>
  </div>

  <div id="expenses-section" class="expenses-section">
    <div class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
    <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤...</div>
    <div id="expenses"></div>
    <div id="empty" style="display:none;">
      –ü–æ–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–µ—Ç.<br>
      –û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É —Ä–∞—Å—Ö–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:<br>
      <strong>—Å—É–º–º–∞ // –æ–ø–∏—Å–∞–Ω–∏–µ // –∫–∞—Ç–µ–≥–æ—Ä–∏—è</strong>
    </div>
  </div>

  <div id="categories-section" class="expenses-section" style="display:none;">
    <div class="section-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
    <div id="categories-list" class="categories-list"></div>

    <div id="category-expenses-wrapper" style="margin-top:16px; display:none;">
      <div class="section-title" id="category-expenses-title"></div>
      <div id="category-expenses"></div>
    </div>
  </div>

  <button id="close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
    let telegramUserId = null;
    let userName = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    
    // –°–ø–æ—Å–æ–± 0: –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –±–æ—Ç–æ–º)
    const urlParams = new URLSearchParams(window.location.search);
    const userIdFromUrl = urlParams.get('user_id');
    console.log('0. –ü—Ä–æ–≤–µ—Ä–∫–∞ user_id –∏–∑ URL (query):', userIdFromUrl);
    
    // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –∏–∑ hash (Telegram –º–æ–∂–µ—Ç –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
    if (!userIdFromUrl && window.location.hash) {
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const userIdFromHash = hashParams.get('user_id');
      console.log('0.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ user_id –∏–∑ hash:', userIdFromHash);
      if (userIdFromHash) {
        telegramUserId = parseInt(userIdFromHash);
        console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω user_id –∏–∑ hash:', telegramUserId);
      }
    }
    
    if (userIdFromUrl) {
      telegramUserId = parseInt(userIdFromUrl);
      console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω user_id –∏–∑ URL (query):', telegramUserId);
    }
    
    // –°–ø–æ—Å–æ–± 1: –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ initDataUnsafe (—Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π)
    if (!telegramUserId) {
      const user = tg.initDataUnsafe?.user;
      console.log('1. initDataUnsafe.user:', user);
      
      if (user?.id) {
        telegramUserId = user.id;
        userName = user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω user –∏–∑ initDataUnsafe');
      } else {
        // –°–ø–æ—Å–æ–± 2: –ü–∞—Ä—Å–∏–º tg.initData
      let initData = tg.initData;
      console.log('2. tg.initData:', initData ? '–µ—Å—Ç—å' : '–ø—É—Å—Ç–æ');
      
      // –°–ø–æ—Å–æ–± 3: –ü–æ–ª—É—á–∞–µ–º –∏–∑ URL (hash –∏–ª–∏ query)
      if (!initData) {
        const fullUrl = window.location.href;
        console.log('3. window.location.href:', fullUrl);
        
        // –ò—â–µ–º tgWebAppData –≤ hash
        if (window.location.hash) {
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          initData = hashParams.get('tgWebAppData') || '';
          console.log('4. tgWebAppData –∏–∑ hash:', initData ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
        
        // –ò—â–µ–º –≤ query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
        if (!initData) {
          const urlParams = new URLSearchParams(window.location.search);
          initData = urlParams.get('tgWebAppData') || '';
          console.log('5. tgWebAppData –∏–∑ query:', initData ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
        
        // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ —Å–∞–º–æ–º URL —Å—Ç—Ä–æ–∫–µ
        if (!initData) {
          const tgWebAppDataMatch = fullUrl.match(/tgWebAppData=([^&#]+)/);
          if (tgWebAppDataMatch) {
            initData = decodeURIComponent(tgWebAppDataMatch[1]);
            console.log('6. tgWebAppData –∏–∑ regex:', initData ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
          }
        }
      }
      
      if (initData) {
        try {
          // –ü–∞—Ä—Å–∏–º query string
          const params = new URLSearchParams(initData);
          let userStr = params.get('user');
          console.log('7. user –∏–∑ initData (raw):', userStr ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
          
          if (userStr) {
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥–≤–æ–π–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)
            let decoded = userStr;
            for (let i = 0; i < 3; i++) {
              try {
                const temp = decodeURIComponent(decoded);
                if (temp === decoded) break; // –ë–æ–ª—å—à–µ –Ω–µ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è
                decoded = temp;
              } catch (e) {
                break;
              }
            }
            
            console.log('8. decoded user:', decoded);
            const userData = JSON.parse(decoded);
            telegramUserId = userData.id;
            userName = userData.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            console.log('‚úÖ –†–∞—Å–ø–∞—Ä—Å–µ–Ω user:', userData);
          }
        } catch (e) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
        }
      }
      }
    }
    
    // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ user_id –∏–∑ URL, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (telegramUserId && userName === '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å') {
      // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –∏–∑ initDataUnsafe
      const user = tg.initDataUnsafe?.user;
      if (user?.first_name) {
        userName = user.first_name;
      }
    }
    
    console.log('–ò—Ç–æ–≥–æ–≤—ã–π telegramUserId:', telegramUserId);
    console.log('–ò—Ç–æ–≥–æ–≤—ã–π userName:', userName);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    document.getElementById('greeting').textContent = `–ü—Ä–∏–≤–µ—Ç, ${userName}! üëã`;

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—è –≤–≤–æ–¥–∞
    let inputMode = 'normal'; // 'normal' | 'waiting_prompt' | 'waiting_categories'
    let currentTab = 'expenses'; // 'expenses' | 'categories'
    let categoriesLoaded = false;
    let activeCategoryName = null;
    const inputEl = document.getElementById('universal-input');
    const sendBtn = document.getElementById('send-btn');
    const hintEl = document.getElementById('input-hint');

    const expensesSection = document.getElementById('expenses-section');
    const categoriesSection = document.getElementById('categories-section');
    const tabExpenses = document.getElementById('tab-expenses');
    const tabCategories = document.getElementById('tab-categories');

    function switchTab(tab) {
      currentTab = tab;

      if (tab === 'expenses') {
        tabExpenses.classList.add('tab-active');
        tabCategories.classList.remove('tab-active');
        expensesSection.style.display = '';
        categoriesSection.style.display = 'none';
      } else {
        tabExpenses.classList.remove('tab-active');
        tabCategories.classList.add('tab-active');
        expensesSection.style.display = 'none';
        categoriesSection.style.display = '';

        if (!categoriesLoaded) {
          loadCategories();
        }
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—è
    async function handleSendInput() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª–µ –∞–∫—Ç–∏–≤–Ω–æ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å disabled)
      if (inputEl.disabled) {
        return;
      }
      
      const text = inputEl.value.trim();
      if (!text) {
        return;
      }

      if (inputMode === 'waiting_prompt') {
        // –†–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
        await generateImageWithPrompt(text);
      } else if (inputMode === 'waiting_categories') {
        // –†–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        await submitCategories(text);
      } else {
        // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º (–¥–ª—è –±—É–¥—É—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π: —Ä–∞—Å—Ö–æ–¥—ã, –ª–∏–º–∏—Ç—ã)
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ:', text);
        // TODO: –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
      }

      // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
      inputEl.value = '';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleSendInput();
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
    sendBtn.addEventListener('click', handleSendInput);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadUserImage() {
      if (!telegramUserId) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É: –Ω–µ—Ç telegramUserId');
        return;
      }
      
      try {
        const res = await fetch(`/miniapp/user-image?telegram_user_id=${telegramUserId}`);
        if (res.ok) {
          const data = await res.json();
          const imgEl = document.getElementById('user-image');
          if (imgEl && data.image_url) {
            imgEl.src = data.image_url;
            console.log('–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', data.image_url, 'is_custom:', data.is_custom);
          }
        } else {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏:', res.status);
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
      }
    }

    // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    function generateImage() {
      if (!telegramUserId) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞
      inputMode = 'waiting_prompt';
      inputEl.disabled = false;
      inputEl.placeholder = '–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤)';
      hintEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å';
      sendBtn.disabled = false;
      inputEl.focus();
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      const btn = document.getElementById('generate-image-btn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è...';
      }
    }

    // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –≤–≤–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function startCategoriesInput() {
      if (!telegramUserId) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }

      inputMode = 'waiting_categories';
      inputEl.disabled = false;
      inputEl.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: –µ–¥–∞, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∂–∏–ª—å–µ)';
      hintEl.textContent = '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—è ¬´–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ¬ª.';
      sendBtn.disabled = false;
      inputEl.focus();
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –ø—Ä–æ–º–ø—Ç–æ–º –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function generateImageWithPrompt(userPrompt) {
      if (!telegramUserId) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –ø—Ä–æ–º–ø—Ç–∞
      if (userPrompt.length > 200) {
        alert('–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤.');
        resetInputMode();
        return;
      }
      
      const btn = document.getElementById('generate-image-btn');
      const imgEl = document.getElementById('user-image');
      
      if (!btn || !imgEl) {
        console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        return;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      btn.disabled = true;
      btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
      hintEl.textContent = '–£–ª—É—á—à–∞—é –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É...';
      sendBtn.disabled = true;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ
      const originalSrc = imgEl.src;
      imgEl.style.opacity = '0.5';
      
      try {
        const res = await fetch(`/miniapp/generate-image?telegram_user_id=${telegramUserId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ prompt: userPrompt }),
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        
        if (data.ok && data.image_url) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –Ω–µ–±–æ–ª—å—à–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
          setTimeout(() => {
            imgEl.src = data.image_url + '?t=' + Date.now(); // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫—ç—à–∞
            imgEl.style.opacity = '1';
            btn.textContent = 'üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É';
            btn.disabled = false;
            console.log('–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞:', data.image_url);
          }, 500);
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –≤–≤–æ–¥–∞ (–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ)
          resetInputMode();
        } else {
          throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏:', e);
        alert(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏: ${e.message}`);
        imgEl.src = originalSrc;
        imgEl.style.opacity = '1';
        btn.textContent = 'üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É';
        btn.disabled = false;
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ç–∞–∫–∂–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        resetInputMode();
      }
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞ –±—ç–∫–µ–Ω–¥
    async function submitCategories(categoriesText) {
      if (!telegramUserId) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }

      // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
      if (!categoriesText || !categoriesText.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é.');
        return;
      }

      hintEl.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...';
      sendBtn.disabled = true;

      try {
        const res = await fetch(`/miniapp/categories?telegram_user_id=${telegramUserId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ categories: categoriesText }),
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }

        const data = await res.json();
        console.log('–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã/–Ω–∞–π–¥–µ–Ω—ã:', data);

        if (data.ok) {
          const list = Array.isArray(data.categories) ? data.categories.join(', ') : '';
          hintEl.textContent = list
            ? `–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ${list}`
            : '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.';
        } else {
          hintEl.textContent = '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.';
        }

        // –ß–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à–æ–µ –≤—Ä–µ–º—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
        setTimeout(() => {
          resetInputMode();
        }, 1500);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', e);
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ${e.message}`);
        resetInputMode();
      }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    async function loadCategories() {
      if (!telegramUserId) {
        return;
      }

      const container = document.getElementById('categories-list');
      const expensesWrapper = document.getElementById('category-expenses-wrapper');
      const expensesContainer = document.getElementById('category-expenses');
      const expensesTitle = document.getElementById('category-expenses-title');

      container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...';
      expensesWrapper.style.display = 'none';
      expensesContainer.innerHTML = '';
      expensesTitle.textContent = '';

      try {
        const res = await fetch(`/miniapp/categories/list?telegram_user_id=${telegramUserId}`);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }

        const data = await res.json();
        categoriesLoaded = true;

        if (!data || data.length === 0) {
          container.innerHTML = '<div class="loading">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´‚ûï –ö–∞—Ç–µ–≥–æ—Ä–∏–∏¬ª.</div>';
          return;
        }

        container.innerHTML = '';

        data.forEach((cat) => {
          const btn = document.createElement('button');
          btn.className = 'category-chip';
          btn.textContent = cat.name;
          btn.addEventListener('click', () => {
            setActiveCategory(cat.name);
            loadCategoryExpenses(cat.name);
          });
          container.appendChild(btn);
        });
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', e);
        container.innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.</div>';
      }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    async function loadCategoryExpenses(categoryName) {
      if (!telegramUserId) {
        return;
      }

      const wrapper = document.getElementById('category-expenses-wrapper');
      const container = document.getElementById('category-expenses');
      const titleEl = document.getElementById('category-expenses-title');

      wrapper.style.display = 'block';
      container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...</div>';
      titleEl.textContent = `–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${categoryName}`;

      try {
        const url = `/miniapp/expenses/by-category?telegram_user_id=${telegramUserId}&category_name=${encodeURIComponent(categoryName)}&limit=50`;
        console.log('–ó–∞–ø—Ä–æ—Å —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', url);

        const res = await fetch(url);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }

        const data = await res.json();
        container.innerHTML = '';

        if (!data || data.length === 0) {
          container.innerHTML = '<div class="loading">–†–∞—Å—Ö–æ–¥–æ–≤ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
          return;
        }

        data.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'expense';

          const amountRub = (item.amount_cents || 0) / 100;
          const cat = item.category_name || categoryName || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
          const desc = item.description || '';
          const date = item.occurred_at || '';

          div.innerHTML = `
            <div class="expense-left">
              <div class="expense-amount">${amountRub.toFixed(2)} ‚ÇΩ</div>
              <div class="expense-category">${cat}</div>
              ${desc ? `<div class="expense-description">${desc}</div>` : ''}
            </div>
            ${date ? `<div class="expense-date">${date}</div>` : ''}
          `;

          container.appendChild(div);
        });
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', e);
        container.innerHTML = `<div class="loading">–û—à–∏–±–∫–∞: ${e.message}</div>`;
      }
    }

    function setActiveCategory(name) {
      activeCategoryName = name;
      const chips = document.querySelectorAll('.category-chip');
      chips.forEach((chip) => {
        if (chip.textContent === name) {
          chip.classList.add('category-chip-active');
        } else {
          chip.classList.remove('category-chip-active');
        }
      });
    }

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –≤–≤–æ–¥–∞ –≤ –æ–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ)
    function resetInputMode() {
      inputMode = 'normal';
      inputEl.disabled = true;
      inputEl.placeholder = '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–µ–π—Å—Ç–≤–∏—è –≤—ã—à–µ...';
      hintEl.textContent = '';
      sendBtn.disabled = true;
    }

    async function loadExpenses() {
      const loadingEl = document.getElementById('loading');
      const container = document.getElementById('expenses');
      const empty = document.getElementById('empty');

      // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å user_id, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥ —Å initData
      if (!telegramUserId) {
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å initData –∏–∑ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        let initData = tg.initData;
        
        if (!initData) {
          // –ü—Ä–æ–±—É–µ–º –∏–∑ hash
          const hash = window.location.hash;
          if (hash) {
            const hashParams = new URLSearchParams(hash.substring(1));
            initData = hashParams.get('tgWebAppData') || '';
          }
        }
        
        if (!initData) {
          // –ü—Ä–æ–±—É–µ–º –∏–∑ query
          const urlParams = new URLSearchParams(window.location.search);
          initData = urlParams.get('tgWebAppData') || '';
        }
        
        if (!initData) {
          // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ –ø–æ–ª–Ω–æ–º URL —á–µ—Ä–µ–∑ regex
          const fullUrl = window.location.href;
          const match = fullUrl.match(/tgWebAppData=([^&#]+)/);
          if (match) {
            initData = decodeURIComponent(match[1]);
          }
        }
        
        console.log('–ü—Ä–æ–±—É–µ–º fallback —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥, initData:', initData ? '–Ω–∞–π–¥–µ–Ω' : '–ø—É—Å—Ç–æ–π');
        
        if (initData) {
          try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º initData –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
            const res = await fetch('/miniapp/user-info', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({initData: initData})
            });
            
            console.log('–û—Ç–≤–µ—Ç –æ—Ç /miniapp/user-info:', res.status, res.statusText);
            
            if (res.ok) {
              const data = await res.json();
              console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç –±—ç–∫–µ–Ω–¥–∞:', data);
              telegramUserId = data.telegram_user_id;
              userName = data.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
              document.getElementById('greeting').textContent = `–ü—Ä–∏–≤–µ—Ç, ${userName}! üëã`;
            } else {
              const errorText = await res.text();
              console.error('–û—à–∏–±–∫–∞ –æ—Ç –±—ç–∫–µ–Ω–¥–∞:', res.status, errorText);
            }
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è user_id —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥:', e);
          }
        } else {
          console.error('initData –ø—É—Å—Ç–æ–π –≤–æ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö!');
          console.error('–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É WebApp –≤ Telegram –±–æ—Ç–µ.');
        }
      }

      // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ user_id, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
      if (!telegramUserId) {
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥ –±–µ–∑ initData
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ WebApp API
        console.log('–ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥...');
        console.log('tg.initDataUnsafe:', tg.initDataUnsafe);
        console.log('tg.version:', tg.version);
        console.log('tg.platform:', tg.platform);
        
        try {
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥ —Å –ø—Ä–æ—Å—å–±–æ–π –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          // –ë—ç–∫–µ–Ω–¥ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–ø–æ—Å–æ–±—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
          const res = await fetch('/miniapp/get-user-by-context', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              initDataUnsafe: tg.initDataUnsafe,
              version: tg.version,
              platform: tg.platform,
            })
          });
          
          if (res.ok) {
            const data = await res.json();
            if (data.telegram_user_id) {
              telegramUserId = data.telegram_user_id;
              userName = data.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
              document.getElementById('greeting').textContent = `–ü—Ä–∏–≤–µ—Ç, ${userName}! üëã`;
              console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω user —á–µ—Ä–µ–∑ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±:', data);
            }
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ —Å–ø–æ—Å–æ–±–∞:', e);
        }
      }

      if (!telegramUserId) {
        loadingEl.innerHTML = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.<br><br>–£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ (–∫–æ–º–∞–Ω–¥–∞ /app).';
        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å telegramUserId. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤—ã—à–µ.');
        return;
      }

      try {
        loadingEl.style.display = 'block';
        container.innerHTML = '';
        empty.style.display = 'none';

        const url = `/miniapp/expenses?telegram_user_id=${telegramUserId}&limit=50`;
        console.log('–ó–∞–ø—Ä–æ—Å –∫:', url);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 —Å–µ–∫—É–Ω–¥
        
        try {
          const res = await fetch(url, {
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', res.status, res.statusText);
          
          if (!res.ok) {
            const errorText = await res.text();
            console.error('–û—à–∏–±–∫–∞ HTTP:', res.status, errorText);
            throw new Error(`HTTP ${res.status}: ${errorText}`);
          }
          
          const data = await res.json();
          console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', data);
          loadingEl.style.display = 'none';

          if (!data || data.length === 0) {
            empty.style.display = 'block';
            return;
          }

          data.forEach((item) => {
            const div = document.createElement('div');
            div.className = 'expense';
            
            const amountRub = (item.amount_cents || 0) / 100;
            const cat = item.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
            const desc = item.description || '';
            const date = item.occurred_at || '';
            
            div.innerHTML = `
              <div class="expense-left">
                <div class="expense-amount">${amountRub.toFixed(2)} ‚ÇΩ</div>
                <div class="expense-category">${cat}</div>
                ${desc ? `<div class="expense-description">${desc}</div>` : ''}
              </div>
              ${date ? `<div class="expense-date">${date}</div>` : ''}
            `;
            
            container.appendChild(div);
          });
        } catch (e) {
          clearTimeout(timeoutId);
          throw e;
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤:', e);
        if (e.name === 'AbortError') {
          loadingEl.textContent = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
        } else {
          loadingEl.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤: ${e.message}`;
        }
      }
    }

    document.getElementById('close-btn').addEventListener('click', () => {
      tg.close();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
    const generateBtn = document.getElementById('generate-image-btn');
    if (generateBtn) {
      generateBtn.addEventListener('click', generateImage);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    const manageCategoriesBtn = document.getElementById('manage-categories-btn');
    if (manageCategoriesBtn) {
      manageCategoriesBtn.addEventListener('click', startCategoriesInput);
    }

    // –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ–∫–∞ (–ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–∞–π–ª–æ–≤—ã–π –¥–∏–∞–ª–æ–≥)
    const uploadReceiptBtn = document.getElementById('upload-receipt-btn');
    const uploadReceiptInput = document.getElementById('upload-receipt-input');
    if (uploadReceiptBtn && uploadReceiptInput) {
      uploadReceiptBtn.addEventListener('click', () => {
        uploadReceiptInput.click();
      });

      uploadReceiptInput.addEventListener('change', () => {
        if (!uploadReceiptInput.files || uploadReceiptInput.files.length === 0) {
          return;
        }
        const file = uploadReceiptInput.files[0];
        console.log('–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª —á–µ–∫–∞:', file);
        hintEl.textContent = '–ß–µ–∫ –≤—ã–±—Ä–∞–Ω, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ.';
        // –ó–¥–µ—Å—å –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–∞–π–ª–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥
      });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
    if (tabExpenses) {
      tabExpenses.addEventListener('click', () => switchTab('expenses'));
    }
    if (tabCategories) {
      tabCategories.addEventListener('click', () => switchTab('categories'));
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    loadUserImage();
    loadExpenses();
  </script>
</body>
</html>
