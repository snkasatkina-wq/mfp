<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ú–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      min-height: 100vh;
    }
    
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    h1 {
      font-size: 24px;
      margin: 0 0 8px 0;
      font-weight: 600;
    }
    
    .greeting {
      font-size: 16px;
      color: var(--tg-theme-hint-color, #999999);
      margin-bottom: 16px;
    }
    
    .image-container {
      text-align: center;
      margin: 20px 0;
    }
    
    img {
      max-width: 200px;
      width: 100%;
      height: auto;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .expenses-section {
      margin-top: 24px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .expense {
      padding: 12px;
      border-radius: 12px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      margin-bottom: 8px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .expense-left {
      flex: 1;
    }
    
    .expense-amount {
      font-size: 18px;
      font-weight: 600;
      color: var(--tg-theme-button-color, #2a9df4);
      margin-bottom: 4px;
    }
    
    .expense-category {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #999999);
      margin-bottom: 4px;
    }
    
    .expense-description {
      font-size: 14px;
      color: var(--tg-theme-text-color, #000000);
    }
    
    .expense-date {
      font-size: 11px;
      color: var(--tg-theme-hint-color, #999999);
      white-space: nowrap;
      margin-left: 12px;
    }
    
    #empty {
      text-align: center;
      padding: 40px 20px;
      font-size: 14px;
      color: var(--tg-theme-hint-color, #999999);
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--tg-theme-hint-color, #999999);
    }
    
    button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      background: var(--tg-theme-button-color, #2a9df4);
      color: var(--tg-theme-button-text-color, #ffffff);
      cursor: pointer;
      width: 100%;
      font-weight: 500;
    }
    
    button:active {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üí∞ –ú–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã</h1>
    <div class="greeting" id="greeting">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <div class="image-container">
    <img src="/static/piggy.png" alt="–ö–æ–ø–∏–ª–∫–∞" />
  </div>

  <div class="expenses-section">
    <div class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
    <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤...</div>
    <div id="expenses"></div>
    <div id="empty" style="display:none;">
      –ü–æ–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–µ—Ç.<br>
      –û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É —Ä–∞—Å—Ö–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:<br>
      <strong>—Å—É–º–º–∞ // –æ–ø–∏—Å–∞–Ω–∏–µ // –∫–∞—Ç–µ–≥–æ—Ä–∏—è</strong>
    </div>
  </div>

  <button id="close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
    let telegramUserId = null;
    let userName = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    
    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ initDataUnsafe (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
    const user = tg.initDataUnsafe?.user;
    console.log('initDataUnsafe.user:', user);
    
    if (user?.id) {
      telegramUserId = user.id;
      userName = user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω user –∏–∑ initDataUnsafe');
    } else {
      // –ü—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å initData –≤—Ä—É—á–Ω—É—é
      const initData = tg.initData;
      console.log('initData:', initData);
      console.log('initDataUnsafe:', tg.initDataUnsafe);
      
      if (initData) {
        try {
          // initData –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ query string
          const params = new URLSearchParams(initData);
          const userStr = params.get('user');
          console.log('user –∏–∑ initData (raw):', userStr);
          
          if (userStr) {
            const userData = JSON.parse(decodeURIComponent(userStr));
            telegramUserId = userData.id;
            userName = userData.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            console.log('‚úÖ –†–∞—Å–ø–∞—Ä—Å–µ–Ω user –∏–∑ initData:', userData);
          }
        } catch (e) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ initData:', e);
        }
      }
    }
    
    console.log('telegramUserId:', telegramUserId);
    console.log('userName:', userName);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    document.getElementById('greeting').textContent = `–ü—Ä–∏–≤–µ—Ç, ${userName}! üëã`;

    async function loadExpenses() {
      const loadingEl = document.getElementById('loading');
      const container = document.getElementById('expenses');
      const empty = document.getElementById('empty');

      // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å user_id, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥ —Å initData
      if (!telegramUserId) {
        const initData = tg.initData;
        if (initData) {
          try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º initData –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
            const res = await fetch('/miniapp/user-info', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({initData: initData})
            });
            if (res.ok) {
              const data = await res.json();
              telegramUserId = data.telegram_user_id;
              userName = data.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
              document.getElementById('greeting').textContent = `–ü—Ä–∏–≤–µ—Ç, ${userName}! üëã`;
            }
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è user_id —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥:', e);
          }
        }
      }

      if (!telegramUserId) {
        loadingEl.textContent = '–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      try {
        loadingEl.style.display = 'block';
        container.innerHTML = '';
        empty.style.display = 'none';

        const res = await fetch(`/miniapp/expenses?telegram_user_id=${telegramUserId}&limit=50`);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        
        const data = await res.json();
        loadingEl.style.display = 'none';

        if (!data || data.length === 0) {
          empty.style.display = 'block';
          return;
        }

        data.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'expense';
          
          const amountRub = (item.amount_cents || 0) / 100;
          const cat = item.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
          const desc = item.description || '';
          const date = item.occurred_at || '';
          
          div.innerHTML = `
            <div class="expense-left">
              <div class="expense-amount">${amountRub.toFixed(2)} ‚ÇΩ</div>
              <div class="expense-category">${cat}</div>
              ${desc ? `<div class="expense-description">${desc}</div>` : ''}
            </div>
            ${date ? `<div class="expense-date">${date}</div>` : ''}
          `;
          
          container.appendChild(div);
        });
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤:', e);
        loadingEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.';
      }
    }

    document.getElementById('close-btn').addEventListener('click', () => {
      tg.close();
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    loadExpenses();
  </script>
</body>
</html>
